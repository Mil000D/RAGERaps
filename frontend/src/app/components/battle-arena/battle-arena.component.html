<section class="battle-arena" *ngIf="battle">
  <div class="container arena-container">
    <header class="arena-header">
      <h2 class="arena-title">RAGE<span class="title-highlight">Raps</span> Battle Arena</h2>
    </header>
    
    <div class="battle-header">
      <h1>{{ battle.rapper1_name }} vs {{ battle.rapper2_name }}</h1>
      <div class="battle-meta">
        <span class="battle-style">{{ battle.style1 }} vs {{ battle.style2 }}</span>
        <span class="battle-status" [class.completed]="battle.status === 'completed'">
          {{ battle.status === 'completed' ? 'Completed' : 'In Progress' }}
        </span>
        <span class="battle-round" *ngIf="battle.current_round">
          Round: {{ battle.current_round }} of 3
        </span>
      </div>
      
      <div class="battle-score">
        <div class="rapper" [class.winner]="battle.winner === battle.rapper1_name">
          <div class="rapper-initial">{{ getInitial(battle.rapper1_name) }}</div>
          <h3 class="rapper-name">{{ battle.rapper1_name }}</h3>
          <div class="wins">{{ rapper1Wins }}</div>
        </div>
        <div class="vs">VS</div>
        <div class="rapper" [class.winner]="battle.winner === battle.rapper2_name">
          <div class="rapper-initial">{{ getInitial(battle.rapper2_name) }}</div>
          <h3 class="rapper-name">{{ battle.rapper2_name }}</h3>
          <div class="wins">{{ rapper2Wins }}</div>
        </div>
      </div>
      
      <div *ngIf="battle.winner" class="winner-announcement">
        Winner: {{ battle.winner }}
      </div>
    </div>
    
    <div class="battle-rounds">
      <div *ngFor="let round of battle.rounds" class="round">
        <div class="round-header">
          <h2>Round {{ round.round_number }}</h2>
          <span class="round-status" [class.completed]="round.status === 'completed'">
            {{ round.status === 'completed' ? 'Completed' : 'In Progress' }}
          </span>
        </div>
        
        <div class="verses">
          <div class="verse" *ngIf="round.rapper1_verse">
            <h3>{{ round.rapper1_verse.rapper_name }}</h3>
            <pre>{{ round.rapper1_verse.content }}</pre>
          </div>
          <div class="verse" *ngIf="round.rapper2_verse">
            <h3>{{ round.rapper2_verse.rapper_name }}</h3>
            <pre>{{ round.rapper2_verse.content }}</pre>
          </div>
        </div>
        
        <div class="judgment" *ngIf="round.user_judgment">
          <h3>User Judgment</h3>
          <div class="judgment-content">
            <div class="judgment-winner">
              Winner: <strong>{{ round.user_judgment.winner }}</strong>
            </div>
            <div class="judgment-feedback">
              {{ round.user_judgment.feedback }}
            </div>
          </div>
        </div>
        
        <div class="judgment" *ngIf="round.judge_feedback">
          <h3>AI Judgment</h3>
          <div class="judgment-content">
            <div class="judgment-winner" *ngIf="round.winner">
              Winner: <strong>{{ round.winner }}</strong>
            </div>
            <div class="judgment-feedback">
              {{ round.judge_feedback }}
            </div>
          </div>
        </div>
        
        
        <div class="judge-actions" *ngIf="round.rapper1_verse && round.rapper2_verse && !round.winner && battle.status === 'in_progress'">
          <h3>Judge This Round</h3>
          <div class="judge-options">
            <button class="ai-judge-btn" 
                    (click)="judgeRoundWithAI(battle.id!, round.id!)" 
                    [disabled]="loading">
              {{ loading ? 'Judging...' : 'Let AI Judge' }}
            </button>
            
            <div class="or-divider">OR</div>
            
            <div class="user-judge">
              <form [formGroup]="judgmentForm" (ngSubmit)="judgeRoundByUser(battle.id!, round.id!)">
                <div class="form-group">
                  <label>Pick Winner</label>
                  <div class="radio-group">
                    <div class="radio-option">
                      <input type="radio" [id]="'rapper1-' + round.round_number" formControlName="winner" [value]="battle.rapper1_name">
                      <label [for]="'rapper1-' + round.round_number">{{ battle.rapper1_name }}</label>
                    </div>
                    <div class="radio-option">
                      <input type="radio" [id]="'rapper2-' + round.round_number" formControlName="winner" [value]="battle.rapper2_name">
                      <label [for]="'rapper2-' + round.round_number">{{ battle.rapper2_name }}</label>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="feedback">Your Feedback</label>
                  <textarea id="feedback" formControlName="feedback" placeholder="Why did you choose this winner?"></textarea>
                </div>
                
                <button type="submit" class="submit-btn" [disabled]="judgmentForm.invalid || loading">
                  Submit Your Judgment
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="battle-actions">
      <button class="back-btn" (click)="backToList()">Back to Battles</button>
    </div>
  </div>
</section>

<div *ngIf="!battle && !error" class="loading">
  Loading battle...
</div>

<div *ngIf="error" class="error">
  {{ error }}
  <button class="back-btn" (click)="backToList()">Back to Battles</button>
</div>
